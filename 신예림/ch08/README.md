# 바이트코드 실행 엔진

가상 머신 구현에서 실행 엔진이 바이트코드를 실행하는 방법은 

1. 해석 샐행 (인터프리터 실행)
2. 컴파일 실행 (JIT 컴파일러로 네이티브 코드 생성 후 실행)

중 하나이다. 실행 엔진 하나에서 두 가지 방식을 혼용할 수도, 여러가지 JIT 컴파일러를 혼용할 수 있다.

어떤 방식을 선택하더라도 **모든 자바 가상 머신의 실행 엔진은 같은 입력에 같은 출력을 낸다.**

## 런타임 스택 프레임 구조

자바 가상 머신은 메서드를 가장 기본적인 실행 단위로 사용하며, 메서드 호출과 실행을 위해 스택 프레임 데이터 구조를 사용한다.
이 스택 프레임에는 메서드의 지역 변수 테이블, 피연산자 스택, 동적 링크, 반환 주소 등 같은 정보가 담긴다.

실행 엔진 관점에서는 활성 스레드에서 스택 맨 위에 있는 메서드만 실행중이며, 스택 맨 위에 있는 스택 프레임만 유효하다. (**현재 스택 프레임**) 현재 스택 프레임이 대변하는 메서드를 현재 메서드라 한다.

### 지역 변수 테이블

메서드 매개 변수와 메서드 안에서 정의된 지역 변수를 저장하는 공간이다. 
용량 기준은 가장 작은 단위인 변수 슬롯이다.

자바 가상 머신은 지역 변수 테이블을 인덱스 방식으로 사용한다.

메서드 호출 시 매개변수들도 지역 변수 테이블을 통해 전달된다.
인스턴스 메서드를 호출할 때, 지역 변수 슬롯의 0번째 슬롯에 메서드가 속한 객체 인스턴스의 참조 -this-를 전달하므로 메서드 내에서 `this`를 사용할 수 있다. 이후 메서드 매개 변수들과 메서드 본문의 지역 변수들이 정의 순서와 유효 번위에 따라 저장된다. 

스택 프레임이 소비하는 메모리 절약을 위해 변수 슬롯을 재활용할 수도 있으나, GC에 영향을 주는 등의 부작용이 있을 수 있다.
이 부작용에 대한 해법으로 `null` 값을 할당해 변수 슬롯의 기존 정보를 삭제할 수도 있다. 하지만 이 방법은 현재 권장되지 않는다. 대신,

1. 변수 번위를 적절히 지정해 변수가 회수되는 시간을 제어해라.
2. 변수를 사용할 때 명시적으로 초기화해라.
    - 지역 변수는 반드시 명시적으로 초기화해야 하며, 그렇지 않은 경우 컴파일 단계에서 오류가 발생한다.


### 피연산자 스택

메서드 실행 시작에서는 비어 있다가, 실행하는 동안 다양한 바이트코드 명령어가 피연산자 스택에 값을 push하거나 pop한다. 
이 스택 최상단에 위치한 값을 통해 연산을 수행한다.

피연산자 스택의 원소 데이터 타입은 바이트코드 명령어의 순서와 정확히 일치해야 한다.

### 동적 링크

메서드에서 이용하는 외부 객체를 가리키는 참조 정보를 저장한다.

### 반환 주소

메서드 종료 방법은 다음 2개 뿐이다.

1. 실행 엔진이 반환 바이트코드 명령어를 만나면 메서드를 종료한다.
2. 메서드 실행 중 예외가 발생하고, 메서드 본문에서 예외 처리가 이루어지지 않으면 종료된다.

두 가지 방식 모두 종료 후 메서드 호출 위치로 돌아가야 한다. 
정상 종료되는 경우 호출자의 PC 값을 반환 주소로 사용하며, 비정상 종료의 경우 예외 핸들러 테이블에 의해 반환 주소가 결정된다.

## 메서드 호출

메서드 호출 단계에서는 호출할 메서드의 버전을 선택한다.

### 해석

메서드 호출 대상은 모두 클래스 파일의 상수 풀에 심벌 참조로 기록되어 있다.

### 디스패치



## 동적 타입 언어 지원

## 스택 기반 바이트코드 해석 및 실행 엔진