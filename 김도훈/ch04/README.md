# 4장 가상 머신 성능 모니터링과 문제 해결 도구

가상 머신의 메모리 관리를 실용적인 관점에서 이해해보기

시스템에서 발생한 문제의 원인을 찾을 때 관련 **기초 지식은 탄탄한 토대**가 되고 **데이터는 근거**가 되며 **도구는 지식을 활용해 데이터를 처리하는 수단**이 된다.

데이터는 예외 스택, 가상 머신 운영 로그, 가비지 컬렉터 로그, 스레드 덤프 스냅숏(javacore 파일), 힙 덤프 스냅숏(hprof 파일) 등을 모두 포괄한다. 

## 4.2 기본적인 문제 해결 도구

가상 머신 상태 모니터링과 문제 해결에 쓰이는 도구

- **상용 인증 도구** : JMC, JFR이 있다.
    - JMC : 자바 애플리케이션을 관리, 모니터링, 프로파일 및 문제 해결하기 위한 도구 모음
    - JFR : 진단 정보를 지속적으로 기록하는 성능 모니터링 및 프로파일링 도구
- **공식 지원 도구** : 장기간 지원되는 도구들
- **실험적 도구** : 공식 지원되지 않으며 실험적인 도구들

도구들 대부분 크기가 작은 이유는 도구는 명령 줄 도구이고, 실제 동작하는 코드는 자바로 구현되어 JDK 도구 라이브러리에 있기 때문이다.

도구들을 자바로 구현한 이유는 애플리케이션이 프로덕션 환경에서 배포되면 서버에 물리적으로 직접 접근하거나 SSH 등으로 원격 접속하는 데 제약이 있을 수 있는데, 이럴 경우라도 개발자는 JDK 도구 라이브러리의 인터페이스와 구현 코드를 이용하여 강력한 모니터링과 분석 기능을 애플리케이션에서 직접 제공할 수 있기 때문이다.

### 4.2.1 jps: 가상 머신 프로세스 상태 도구

동작 중인 가상 머신 프로세스 목록을 보여 주며 각 프로세스에서 가상 머신이 실행한 메인 클래스(`main()` 메서드를 포함하는 클래스)의 이름과 로컬 가상 머신 식별자(LVMID)를 알려 준다.

### 4.2.2 jstat: 가상 머신 통계 정보 모니터링 도구

가상 머신의 다양한 작동 상태 정보를 모니터링하는 데 사용한다. 로컬 또는 원격 가상 머신 프로세스의 클래스 로딩, 메모리, 가비지 컬렉션, JIT 컴파일과 같은 런타임 데이터를 보여준다.

### 4.2.3 jinfo: 자바 설정 정보 도구

가상 머신의 다양한 매개 변수를 실시간으로 확인하고 변경하는 도구

### 4.2.4 jmap: 자바 메모리 매핑 도구

힙 스냅숏을 파일로 덤프해 주는 자바용 메모리 맵 명령어다.

jmap을 사용하지 않고도 자바 힙을 덤프하는 방법

- -XX:+HeapDumpOnOutOfMemoryError 매개 변수 사용
- kill -3 명령어 (리눅스)

### 4.2.5 jhat: 가상 머신 힙 덤프 스냅숏 분석 도구

JDK 8까지 제공된 JVM 힙 분석 도구이며, jmap으로 덤프한 힙 스냅숏을 분석할 수 있다. JDK 9부터는 jhsdb로 대체됐다.

### 4.2.6 jstack: 자바 스택 추적 도구

현재 가상 머신의 스레드 스냅숏을 생성한다. 주로 스레드가 장시간 멈춰 있을 때 원인을 찾기 위한 목적으로 사용된다. 주된 원인은 **교착 상태**, **무한 루프**, **외부 자원 요청으로 인한 긴 기다림** 등이다.

스레드가 멈춰 있다면 jstack으로 각 스레드의 호출 스택을 볼 수 있고, 각 스레드의 우선순위, CPU 사용 시간, 생성 후 경과 시간, 스레드 상태, 메서드 호출 스택 등 다양한 정보를 알 수 있다.

**스레드 스냅숏** : 현재 가상 머신에서 실행 중인 각 스레드의 메서드 스택들의 집합

## 4.3 GUI 도구

명령 줄 도구 외에도 JDK는 GUI 도구도 제공하며, 대체로 프로세스 오류를 더 쉽게 진단하고 디버깅할 수 있다. 대표적으로 JConsole, JHSDB, VIsualVM, JMC가 있다.

### 4.3.1 JHSDB: 서비스 에이전트 기반 디버깅 도구

SA를 통해 프로세스 외부에서 디버깅할 수 있는 도구다.

**SA** : 핫스팟 가상 머신이 제공하는 API 집합으로, 자바 가상 머신의 런타임 정보를 제공한다. 대부분 자바 언어로 구현되었고 JNI 코드도 일부 사용한다.

### 4.3.2 JConsole: 자바 모니터링 및 관리 콘솔

JMX에 기반한 GUI 모니터링 및 관리 도구다. 주로 정보를 수집하고 JMX MBean을 통해 시스템의 매개 변숫값을 동적으로 조정하는 데 쓰인다. JMX는 가상 머신 자체와 가상 머신에서 구동되는 소프트웨어를 관리하는 용도로 쓰인다.

### 4.3.3 VisualVM: 다용도 문제 대응 도구

일반적인 운영 및 문제 대응 기능에 더해 성능 분석까지 제공하는 올인원 자바 문제 해결 도구다.

- 성능면에서 JProfiler나 YourKit 같은 상용 프로파일러에는 미치지 못한다.
- 모니터링 대상 프로그램에 특별한 에이전트를 심지 않아도 돼서 활용하기 쉽고 애플리케이션 성능에 미치는 영향도 적다. 그래서 프로덕션 환경에도 곧바로 적용 가능하다.

### 4.3.4 JMC: 지속 가능한 온라인 모니터링 도구

가상 머신 MBean이 제공하는 데이터를 보여 주는 JMX 콘솔 역할을 하며, JFR이 제공하는 데이터를 보여 주는 JFR 분석 도구로도 쓰인다.

프로덕션 환경에서는 상용 권한을 얻어야 하지만 개인 용도로는 무료로 이용할 수 있다. 

**JFR** : 핫스팟 가상 머신에 내장된 모니터링 및 이벤트 기반 정보 수집 프레임워크

## 4.4 핫스팟 가상 머신 플러그인과 도구

- **IGV** : C2 JIT 컴파일러가 바이트코드를 아이디얼 그래프로 변환한 후 다시 기계어 코드로 변환하는 과정을 시각화해 준다.
- **CCV** : C1 JIT 컴파일러가 HIR을 생성하고 저수준 중간 표현(LIR)으로 변환한 후 물리 레지스터를 할당하는 과정을 보여 준다.
- **프로젝트 크리에이터** : 비주얼 스튜디오용 **.project** 파일 생성을 도와준다. (JDK 9때 제거됨)
- **LogCompilation** : **-XX:+LogCompilation** 옵션으로 출력된 로그를 더 읽기 편한 포맷으로 변환한다.
- **HSDIS** : JIT 컴파일러용 디스어셈블리

### 4.4.1 HSDIS

- 오라클이 권장하는 핫스팟 가상 머신 JIT 컴파일 코드용 디스어셈블리 플러그인이다.
- OpenJDK에 소스가 포함되어 있어 직접 빌드할 수 있고, 인터넷에서 미리 빌드한 바이너리(*.so 또는 *.dll 파일 형태)도 찾을 수 있다.

### 4.4.2 JITWatch

- 핫스팟 JIT 컴파일러용 로그 분석 및 시각화 도구로, HSDIS와 자주 함께 쓰인다.
- 실행 중인 자바 애플리케이션이 생성한 핫스팟 컴파일 상세 로그를 파싱/분석하여 그 결과를 GUI 형태로 보여준다.
