> 이 포스팅은 [JVM 밑바닥까지 파헤치기](https://ebook.insightbook.co.kr/book/164)책을 참고하여 작성된 글이다.

## 가상 머신 성능 모니터링과 문제 해결 도구

### 들어가며

가상 머신 장애 처리 및 분석 도구를 적절히 이용하면 데이터를 분석하여 문제를 식별하고 해결하는 일이 훨씬 쉬워진다.

### 기본적인 문제 해결 도구

가상 머신 상태 모니터링과 문제 해결에 쓰이는 도구 몇 가지를 소개한다. 이 도구들의 라이선스와 성숙 수준에 따라 다음 세 범주로 나눌 수 있다.

- 상용 인증 도구: JMC와 JFR이 여기에 속한다.
- 공식 지원 도구: 장기간 지원되는 도구들이다.
- 실험적 도구: '공식 지원되지 않으며 실험적'이라는 딱지가 붙은 도구들이다.

이런 도구들은 자바 코드로 구현되어 있는데 이유는 애플리케이션이 프로덕션 환경에 배포되면 서버에 물리적으로 직접 접근하거나 SSH등으로 원격 접속하는데 제약이 있을 수 있다. 이럴 경우라도 개발자는 JDK 도구 라이브러리의 인터페이스와 구현 코드를 이용하여 겅력한 모니터링과 분석 기능을 애플리케이션에서 직접 제공할 수 있다.

#### jps: 가상 머신 프로세스 상태 도구

jps의 이름은 유닉스 ps 명령어에서 따왔고 기능 역시 비슷하다. 즉, 동작 중인 가상 머신 프로세스 목록을 보여 주며 각 프로세스에서 가상 머신이 실행한 메인 클래스의 이름과 로컬 가상 머신 식별자(LVMID)를 알려준다.

> LVMID는 PID와 같다.

> ✅ 명령어
>
> jps [option] [hostid]

또한 jps로는 원격 가상 머신의 프로세스 상태도 알아낼 수 있다. 이때 RMI 서비스를 이용하는데, hostid 매개 변수가 바로 RMI 레지스트리에 등록된 호스트명을 가리킨다.

| 옵션 | 설명                                                               |
| ---- | ------------------------------------------------------------------ |
| -q   | LVMID만 출력                                                       |
| -m   | 가상 머신 프로세스 시작 시 main() 메서드에 전달된 매개 변수 출력   |
| -l   | 메인 클래스의 완전한 이름 출력(jar에서 실행중이라면 jar 경로 출력) |
| -v   | 가상 머신 프로세스 시작 시 주어진 가상 머신 매개 변수 출력         |

#### jstat: 가상 머신 통계 정보 모니터링 도구

JVM 통계적 모니터링 도구인 jstat은 가상 머신의 다양한 작동 상태 정보를 모니터링하는 데 사용한다. 로컬 또는 원격 가상 머신 프로세스의 런타임 데이터를 보여준다.

> ✅ 명령어
>
> jstat [option vmid [interval[s|ms] [count]]]

| 옵션              | 설명                                                                                   |
| ----------------- | -------------------------------------------------------------------------------------- |
| -class            | 클래스 로딩/언로딩 횟수, 총 점유 공간, 클래스 로딩 시간 모니터링                       |
| -gc               | 자바 힙 상태 모니터링. 에덴, 생존자 공간, 구세대 등의 사용량, 총 가비지 컬렉션 시간 등 |
| -gccapacity       | 기본적으로 -gc와 같지만 자바 힙의 다양한 공간의 최대/최소 사용량에 초점을 둠           |
| -gcutil           | 기본적으로 -gc와 같지만 전체 공간 중 사용량애 초점을 둠                                |
| -gccause          | -gcutil 기능에 추가로, 최근 가비지 컬렉션이 일어난 이유 출력                           |
| -gcnew            | 신세대 가비지 컬렉션 상태 모니터링                                                     |
| -gcnewcapacity    | 기본적으로 -gcnew와 같지만 최대/최소 사용량에 초점을 둠                                |
| -gcold            | 구세대 가비지 컬렉션 상태 모니터링                                                     |
| -gcoldcapacity    | 기본적으로 -gcold와 같지만 최대/최소 사용량에 초점을 둠                                |
| -compiler         | JIT 컴파일러가 컴파일한 메서드와 소요 시간 등의 정보 출력                              |
| -printcompilation | 런타임에 컴파일된 메서드들 출력                                                        |

#### jinfo: 자바 설정 정보 도구

jinfo는 가상 머신의 다양한 매개 변수를 실시간으로 확인하고 변경하는 도구다.

> ✅ 명령어
>
> jinfo [options] vmid

#### jmap: 자바 메모리 매핑 도구

jmap은 힙 스냅솟을 파일로 덤프해 주는 자바용 메모리 맵 명령어다. 이 외에도 jmap으로 F-큐, 자바 힙과 메서드 영역 상세 정보(사용량, 적용 중인 컬렉터 등)도 알아 낼 수 있다.

> ✅ 명령어
>
> jmap [options] vmid

| 옵션           | 설명                                                                                     |
| -------------- | ---------------------------------------------------------------------------------------- |
| -dump          | 자바 힙의 스냅솟을 덤프한다. 하위 매개 변수인 live를 추가하면 살아 있는 객체만 덤프한다. |
| -finalizerinfo | F-큐 안의 객체들을 출력한다.                                                             |
| -heap          | 사용 중인 컬렉터, 매개 변수 설정, 세대 상태 등 자바 힙 관련 상세 정보를 출력한다.        |
| -histo         | 클래스와 인스턴스 개수, 총 용량 등 힙에있는 객체들의 통계 정보를 출력한다.               |

#### jhat: 가상 머신 힙 덤프 스냅숏 분석 도구

jhat은 JDK8까지 제공되던 JVM 힙 분석 도구로, jmap으로 덤프한 힙 스냅숏을 분석할 수 있다. JDK9부터 jhsdb가 그 자리를 대신 한다.

하지만 실무에서 많이 사용하지 않는다. 그 이유는 다음과 같다.

- 힙 스냅숏 덤프를 애플리케이션이 배포된 서버에서 직접 분석하는 일은 드물다. 가능한 덤프 파일을 다른 기기로 복사해 분석할 것이다. 분석은 시간이 오래 걸리고 하드웨어 자원을 많이 소모하기 때문이다.
- jhat은 전문 분석 도구보다 기능면에서 떨어진다.

분석 결과는 패키지 단위로 묶어 보여 준다. 메모리 누수 분석에는 주로 힙 히스토그램과 OQL을 이용한다.

#### jstack: 자바 스택 추적 도구

스택 추적 도구인 jstack은 현재 가상 머신의 스레드 스냅숏을 생성하는 데 쓰인다. (일반적으로 스레드 덤프 또는 자바 코어 파일이라고 부른다.)

> 스레드 스냅숏은 현재 가상 머신에서 실행 중인 각 스레드의 메서드 스택들의 집합이다.

주로 스레드가 장시간 멈춰 있을 때 원인을 찾기 위해 생성한다.

| 옵션 | 설명                                           |
| ---- | ---------------------------------------------- |
| -l   | 스택 정보에 더해 락 관련 정보도 함께 출력한다. |
| -e   | 스레드 관련 정보를 추가로 출력한다.            |

해당 도구로 스레드의 우선순위, CPU 사용 시간, 생성 후 경과 시간, 스레드 상태, 메서드 호출 스택 등 다양한 정보를 알 수 있다.

#### 기본 도구 요약

다양한 도구들이 있는데 일단 위의 것들만으로 충분하다고 생각한다. 필요하다면 책을 참고해서 봐도 늦지 않다고 생각한다.

### GUI 도구

가상 머신 문제 해결용 GUI 도구로는 JConsole, JHSDB, VisualVM, JMC가 대표적이다.

#### JHSDB: 서비스 에이전트 기반 디버깅 도구

JDK는 JCMD와 JHSDB라는 두 가지 다목적 통합 도구를 제공한다.

JHSDB는 SA를 통해 프로세스 외부에서 디버깅 할 수 있는 도구다.

> SA란 핫스팟 가상 머신이 제공하는 API 집합으로, 자바 가상 머신의 런타임 정보를 제공한다.

대부분 자바 언어로 구현되었고 JNI 코드도 일부 사용했다.

JHSDB를 이용하여 실무에서 가상 머신 프로세스나 덤프된 메모리 스냅숏을 디버깅하며 구체적인 경험을 쌓아 보기를 바란다고 하셨지만 과연 얼마나 많이 쓸지 의문이다.

#### JConsole: 자바 모니터링 및 관리 콘솔

JConsole은 JMX에 기반한 GUI 모니터링 및 관리 도구다. 주로 정보를 수집하고 JMX MBean을 통해 시스템의 매개 변숫값을 동적으로 조정하는데 쓰인다.

#### VisualVM: 다용도 문제 대응 도구

VisualVM은 일반적인 운영 및 문제 대응 기능에 더해 성능 분석까지 제공하는 올인원 자바 문제 해결 도구다.

#### JMC: 지속 가능한 온라인 모니터링 도구

JFR은 핫스팟 가상 머신에 내장된 모니터링 및 이벤트 기반 정보 수집 프레임워크다.

JMC는 원래 BEA 제품이라서 VisualVM과 달리 넷빈즈 플랫폼을 쓰지 않았다. 그 대신 IBM이 기증한 이클립스 RCP를 기본 프레임워크로 활용한다. 그래서 JMC는 단독으로 실행하기보다는 이클립스 플러그인 형태로 쓰이는 모습을 더 흔히 볼 수 있다.

### 핫스팟 가상 머신 플러그인 도구

핫스팟 개발 과정에서 많은 플러그인과 보조 도구가 제작되어 왔다.

> JDK_SRC_HOME/src/utils 디렉터리
>
> - IGV: C2 JIT 컴파일러가 바이트코드를 아이디얼 그래프로 변환한 후 다시 기계어 코드로 변환하는 과정을 시각화 해준다.
> - CGV: C1 JIT 컴파일러가 HIR을 생성하고 저수준 중간 표현으로 변환한 후 물리 레지스터를 할당하는 과정을 보여준다.
> - 프로젝트 크리에이터: VS용
> - LogCompilation: -XX:+LogCompilation 옵션으로 출력된 로그를 더 읽기 편한 포맷으로 변환
> - HSDIS: JIT 컴파일러용 디어셈블러다.

#### HSDIS

HSDIS는 오라클이 권장하는 핫스팟 가상 머신 JIT 컴파일 코드용 디스어셈블리 플러그인이다. OpenJDK에 소스가 포함되어 있어 직접 빌드할 수도 있고, 인터넷에서 미리 빌드한 바이너리도 찾을 수 있을 것이다.

#### JITWatch

JITWatch는 핫스팟 JIT 컴파일러용 로그 분석 및 시각화 도구로, HSDIS와 자주 함께 쓰인다.
