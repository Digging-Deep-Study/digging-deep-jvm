# 8장 바이트코드 실행 엔진
> 이번 장에서는 가상 머신이 코드를 실행할 때 올바른 메서드를 찾는 방법, 메서드 본문의 바이트코드를 실행하는 방법, 코드 실행과 관련한 메서드 구조 분석에 대해 다룬다.

## 들어가며
실행 엔진: 가상 머신의 핵심 구성 요소.. 가상 머신 <-> 물리 머신(상대적인 개념)
- 물리 머신의 실행 엔진
  - 프로세서, 캐시, 명령어 집합, 운영 체제 수준에서 직접 구현된다.
- 가상 머신의 실행 엔진
  - 순수하게 소프트웨어로만 구현된다.
  - 따라서 명령어 집합의 구조와 실행 엔진을 물리적 제약 없이 원하는 대로 만들 수 있다. 하드웨어에서 직접 지원하지 않는 명령어 집합도 실행할 수 있다는 뜻이다.

<<자바 가상 머신 명세>>는 바이트코드 실행 엔진의 개념 모델을 정의하고 있고, 이 모델이 주요 업체의 자바 가상 머신 엔진들에 통일성을 심어 주는 핵심이다.
- 가상 머신 구현에서 실행 엔진이 바이트코드를 실행하는 방법
  - 해석 실행(인터프리터를 통한 실행)
  - 컴파일 실행(JIT 컴파일러로 네이티브 코드 생성 후 실행) 중 하나다.
  - 물론 실행 엔진 하나에서 둘 다 포함할 수도, 수준이 다른 여러 JIT 컴파일러를 혼용할 수도 있다.

어떤 방식을 택하든 모든 자바 가상 머신의 실행 엔진은 똑같은 입력에 똑같은 출력을 낸다.
- 입력은 바이너리 바이트 스트림이고,
- 이 바이트코드를 해석해 실행한 다음,
- 실행 결과를 출력한다.

## 런타임 스택 프레임 구조
스택 프레임
- 메서드 호출과 실행을 뒷받침하는 내부 데이터 구조이다.
- 가상 머신 런타임 데이터 영역에 있는 가상 머신 스택의 요소이기도 하다.
- 메서드의 지역 변수 테이블, 피연산자 스택, 동적 링크, 반환 주소와 같은 정보가 담긴다.
- 메서드 호출 시작부터 실행 종료까지 과정은 스택 프레임을 가상 머신 스택으로 푸시하는 작업에 해당한다.

### 지역 변수 테이블
...

# 9장 클래스 로딩과 실행 서브시스템, 사례와 실전
> 클래스 로더와 바이트코드 관련 사례, 독자들의 생각을 일깨우고 일상 업무에 영감을 줄 법한 사례

## 톰캣: 정통 클래스 로더 아키텍처
톰켓, 제티, 웹로직, 웹스피어 등 주류 자바 웹 서버는 모두 자체 정의한 클래스 로더를 사용하는데, 다음과 같은 문제들을 해결하기 위해 일반적으로 둘 이상의 로더를 혼용한다.
- 똑같은 서버에 배포하더라도 자바 클래스 라이브러리를 웹 애플리케이션별로 격리하는 게 좋다.
  - 같은 서드 파티 클래스 라이브러리를 이용하더라도 애플리케이션마다 필요로 하는 버전은 다를 수 있다.
  - 즉, 클래스 라이브러리들은 한 서버에 여러 버전이 공존할 수 있다.
  - 따라서 서버는 개별 애플리케이션이 클래스 라이브러리를 독립적으로 사용할 수 있도록 보장해야 한다.
- 똑같은 서버에 배포된 둘 이상의 웹 애플리케이션이 사용하는 자바 클래스 라이브러리는 서로 공유할 수 있다.
  - 서버 한 대에 스프링 프레임워크를 사용하는 애플리케이션을 열 개 배포했다고 해 보자.
  - 스프링 프레임워크를 열 벌이나 복사해 관리한다면 자원 낭비가 크다.
  - 디스크 공간 낭비도 있지만 클래스 라이브러리를 사용하려면 먼저 메모리로 읽어 들여야 한다는 점이 훨씬 심각하다.
  - 클래스 라이브러리를 공유할 수 없다면 가상 머신의 메서드 영역이 과도하게 확장될 위험이 있다.
- 서버는 보안을 최대한 유지해서 배포된 웹 애플리케이션들의 영향을 받지 않아야 한다.
  - 현재 많은 주류 자바 웹 서버가 자바 언어로 구현된다.
  - 따라서 서버 자체에도 클래스 라이브러리 의존성 문제가 있다.
  - 일반적으로 보안상 이유로 서버가 사용하는 클래스 라이브러리는 애플리케이션의 클래스 라이브러리와 독립적이어야 한다.
- JSP 애플리케이션을 지원하는 웹 서버는 대부분 핫 스와프를 지원한다.
  - JSP 파일은 가상 머신에서 실행되기 전에 자바 클래스 파일로 컴파일된다.
  - 하지만 JSP 파일은 서드 파티 클래스 라이브러리나 자바로 작성된 코드보다 런타임에 수정될 가능성이 훨씬 크다.
  - 더구나 ASP, PHP, JSP 등은 코드 수정 후 애플리케이션을 재시작하지 않아도 된다는 점을 커다란 장점으로 내세운다.
  - 따라서 주류 웹 서버는 JSP로부터 생성된 클래스의 핫 스와프를 지원해야 한다.

이상의 조건들 때문에 클래스패스가 하나뿐인 구조는 다수의 웹 애플리케이션을 배포하기에 적합하지 않다. 그래서 다양한 웹 서버에서 서드 팔티 클래스 라이브러리 저장용으로 별도의 클래스패스를 제공하기도 한다.
  - lib
  - classes

저장된 경로가 다른 클래스 라이브러리들은 접근 범위도 서로 다르다. 또한 전용 클래스 로더를 디렉터리마다 따로 제공한다.

이제부터 톰캣이 사용자 클래스 라이브러리 구조와 클래스 로더를 어떻게 다루는 지 구체적으로 알아본다.

톰캣에서는 자바 클래스 라이브러리 저장용 디렉터리 3개와 웹 애플리케이션 자체 저장용 디렉터리 1개를 합해 총 4개의 디렉터리가 핵심이다. 각 디렉터리에 담긴 클래스 라이브러리를 이용할 수 있는 범위는 다음과 같다.

자바 클래스 라이브러리 저장용 디렉터리
- /common: 톰캣 자신과 모든 웹 애플리케이션
- /server: 톰캣 자신
- /shared: 톰캣을 제외한 모든 웹 애플리케이션

웹 애플리케이션 자체 저장용 디렉터리
- /webapp/WEB-INF: 해당 웹 애플리케이션

스프링 프레임어크로 관리되는 웹 애플리케이션 열 개가 있다면, 스프링을 모든 웹 애플리케이션이 공유하도록 common이나 shared 디렉터리에 넣으면 될 것이다. 프레임워크라는 특성상 스프링 역시 사용자 프로그램의 클래스들을 사용할 수 있어야 한다.
그런데 사용자 프로그램은 /webapp/WEB-INF 디렉터리에 존재한다. 이 상황에서 공통 또는 공유 클래스 로더가 로드한, 스프링 로드 범위에 없는 사용자 프로그램에 어떻게 접근할 수 있을까?

## OSGi: 유연한 클래스 로더 아키텍처
OSGi는 IBM 등이 이끄는 OSGi 연합에서 제창한 자바 기반 '동적' 모듈 명세다.

OSGi의 목적은 서비스 제공자가 다양한 가정용 스마트 기기를 하나의 게이트웨이를 통해 제공하는 것이었다. 그 후 자바의 다른 기술 영역에서도 매우 잘 받아들여져서 자바 세계의 '실질적인' 동적 모듈 표준이 되었다.

## 바이트코드 생성 기술과 동적 프락시 구현
JDK에 포함된 javac 컴파일러는 바이트코드 생성 기술의 조상에 해당하며 자바로 작성된었다.
javac 외에도 웹 서버의 JSP 컴파일러, 컴파일타임에 코드를 변경해주는 AOP 프레임워크가 있다.
동적 프락시 기술에서도 흔히 쓰인다.

## 백포트 도구: 자바의 타임머신


## 실전: 원격 실행 기능 직접 구현하기
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             