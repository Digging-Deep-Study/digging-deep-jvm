# Backend Compiler

## Jit Compiler
자주 사용되는 메서드 혹은 코드블록을 네이티브 코드로 컴파일하고 최적화를 적용
- 핫스팟 코드(핫 코드): 런타임 시 자주 사용되는 코드 블록

### 인터프리터와 컴파일러
핫스팟과 OpenJ9는 인터프리터와 컴파일러를 혼합해서 사용

#### 인터프리터
- 컴파일 없이 빠르게 실행 가능
- 메모리 절약 가능
- 적극적 최적화가 무너지는 경우 최적화를 취소 가능

```mermaid
graph LR
    A[인터프리터] -- JIT 컴파일러 --> B[컴파일러]
    B -- 최적화 취소 --> A
```

### 계층형 컴파일
컴파일과 최적화 규모 소요 시간에 따라 여러 계층으로 나누어 수행
- 게층0: 
  - 인터프리터가 프로그램을 순수하게 해석 실행
  - 성능 모니터링 X
- 계층1: 
  - 클라이언트 컴파일러(C1 컴파일러)가 바이트코드를 네이티브 코드로 컴파일 실행
  - 간단하고 안정적인 최적화만 수행
  - 성능 모니터링 X
- 계층2:
    - 클라이언트 컴파일러 사용
    - 성능 모니터링 O (메서드, 반환 횟수 통계 등)
- 계층3:
  - 클라이엍느 컴파일러 사용
  - 성능 모니터링 O (분기 점프, 가상 메서드 호출 포함)
- 계층4:
  - 서버 컴파일러(C2 컴파일러) 사용
  - 최적화 수준이 가장 높음
  - 신뢰도가 낮은 공격적인 최적화 수행
  - 성능 모니터링 O (메서드, 반환 횟수 통계 등)

### 핫 코드
JIT 컴파일러가 컴파일하는 대상
#### 핫코드 유형
- 여러번 호출되는 메서드
- 여러번 실행되는 순환문의 본문

### 컴파일 과정
기본적으로 백그라운드에서 별도의 스레드가 진행
#### 클라이언트 컴파일러 컴파일
1. HIR 생성
2. LIR 생성
3. LIR에 레지스터를 할당 후 네이티브 코드 생성
#### 서버 컴파일러 컴파일
코드 제거, 순환문 언롤링, 순환문 표현식 호이스팅, 공통 하위 표현 제거, 상수 전파 등 수행


## AOT 컴파일러
두가지 방식이 존재함
- 프로그램이 실행되기 전에 미리 컴파일하여 네이티브 코드로 변환
- JIT가 런타임에 수행할 작업을 미리 수행해 캐시에 저장하고 실행 시 사용

### 장점
- 프로그램 실행 시간 단축
- 최고 성능으로 실행되는데 걸리는 시간 단축

### JIT 반격
- 성능 모니터링 기반 최적화
  - 더 많은 지원을 배분해 최적화 가능
- 급진적 예측 최적화
  - AOT 컴파일러만큼 보수적인 필요 X -> 복잡성을 낮추고 결과적으로 성능을 높힘
- 링크타임 최적화

## 컴파일 최적화 기법
- 메서드 인라인
  - 메서드 호출을 제거하고 호출된 메서드의 코드를 호출한 메서드에 삽입
- 탈출 분석
  - 기본 원칙
    - 전역 탈출: 객체가 메서드 밖으로 나와 다른 스레드가 접근할수 있도록 함
    - 인수 탈출: 객체가 인수로 전달되거나 인수에 의해 참조
    - 탈출하지 않음: 탈출하지 않고 메서드 내부에서 생애를 마침
  - 스택할당: 객체가 스레드에서 벗어나지 않는다고 판단하면, 객체를 스택에 할당
  - 스칼라 치환: 객체를 제거하고 멤버 변수에 직접 접근할 수 있도록 함
  - 동기화 제거: 다른 스레드에서 접근할 수 없다고 판단되면 동기화 조치를 제거
- 공통 하위 표현식 제거
  - 중복되는 표현식을 제거
- 배열 경계 검사 제거
  - 댕글링 포인터 문제를 방지하기 위해 배열 경계 검사를 수행
- 이외에도 오토박싱 제거, 안전지점 제거, 리플렉션 제거 등이 존재

## 그랄 컴파일러
핫스팟 컴파일러를 기반으로 고성능, 메모리 사용량 감소, 폴리글랏 프로그래밍, AOT 네이티브 컴파일 등의 특징을 추가함

JVMCI 덕분에 핫스팟 코드로부터 분리할 수 있었음

### JVMCI
JVM 컴파일러 인터페이스
#### 특징
- 핫스팟 가상 머신의 컴파일 요청을 JIT로 전달
- 클래스, 메서드, 필드, 성능 모니터링 정보 등 핫스팟 JIT 컴파일 관련 데이터를 자바 언어 수준의 데이터 구조로 제공
  - 핫스팟 코드 캐시를 추상화하여, 컴파일이 끝난 네이티브 코드를 배포할 수 있도록 함

### 코드 중간 표현
프로그램 의존성 그래프 형태의 아이디얼 그래프를 사용
#### 처리 과정
- 바이트코드
- 아이디얼 그래프
- 최적화
- 네이티브 코드

### 코드 최적화와 생성


